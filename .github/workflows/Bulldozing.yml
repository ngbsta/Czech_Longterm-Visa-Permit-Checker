name: Bulldozer Pro

on:
  schedule:
    # Work every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  
  # Run Manual
  workflow_dispatch:

jobs:
  Bulldozer_Pro_on_Action:
    runs-on: ubuntu-latest
    
    steps:
    - name:  Checkout repository
      uses: actions/checkout@v4
    
    - name:  Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name:  Install Chrome
      run: |
        echo "Installing Chrome..."
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        echo "‚úì Chrome installed"
    
    - name:  Install ChromeDriver
      run: |
        echo "Installing ChromeDriver..."
        CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+' | head -1)
        CHROME_MAJOR=$(echo $CHROME_VERSION | cut -d. -f1)
        echo "Chrome version: $CHROME_VERSION (major: $CHROME_MAJOR)"
        
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_MAJOR}")
        echo "ChromeDriver version: $CHROMEDRIVER_VERSION"
        
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
        unzip -q chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        chromedriver --version
        echo "‚úì ChromeDriver installed"
    
    - name: üìö Install Python dependencies
      run: |
        echo "Installing Python packages..."
        pip install --quiet selenium requests
        echo "‚úì Dependencies installed"
    
    - name: ‚ñ∂Ô∏è Run Visa Tracker
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "========================================"
        echo " Starting Bulldozer Pro"
        echo "========================================"
        python bulldozer_pro.py
        echo "========================================"
        echo "‚úì Bulldozer Pro Completed"
        echo "========================================"
    
    - name:  Upload logs (if any errors)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 7
